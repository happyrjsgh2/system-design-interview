# [4장] 처리율 제한 장치의 설계

- 네트워크 시스템에서 처리율 제한 장치는 클라이언트 또는 서비스가 보내는 트래픽의 처리율을 제한하기 위한 장치
- 서비스 거부 공격에 대한 자원 고갈 방지, 무분별한 요청을 방지함으로써 비용 절감, 서버 과부하를 막을 수 있는 효과가 있음

## (1단계) 문제 이해 및 범위 설정

- 처리율 제한 장치를 구현하는데 사용할 수 있는 알고리즘의 장단점을 고려하여 요구사항 정리
- 장치의 형상 (서버 또는 클라이언트), 제어 규칙 (IP, ID 등), 시스템 규모 등등 파악

## (2단계) 개략적 설계안 제시 및 동의 구하기

- 처리율 제한 장치는 보통 API gateway에 구현이 되어, SSL 처리, 사용자 인증, whitelist 관리 등 수행
- 현재 기술 스택, 사업 요구사항, 비용, 인력 등에 따라 위치가 달라질 수 있음
- 처리율 제한 알고리즘
    + 토큰 버킷 알고리즘
      + 간단하고 폭 넓게 이용되는 알고리즘
      + 버킷에 담을 수 있는 토큰의 최대 개수, 초당 공급되는 토큰의 비율을 입력 받음
      + 통상적으로 end point 마다 별도의 버킷
      + 구현이 쉽고 메모리 사용 측면에서도 효율적이고 짧은 시간에 집중되는 트래픽도 처리 가능 
      + 파라미터 값 튜닝이 까다로움
    + 누출 버킷 알고리즘
      + 요청 처리율이 고정되어 있는 토큰 버킷 알고리즘
      + 안정적 출력이 필요한 경우 적합하지만 단시간에 트래픽이 몰릴 경우 오래된 요청들이 쌓이고 최신 요청은 버려질 수 있음
    + 고정 윈도 카운터 알고리즘
      + 시간을 고정된 간격으로 나누고 각 간격마다 처리할 수 있는 요청의 수를 제한
      + 메모리 효율이 좋고 윈도가 닫히는 시점에 카운터를 초기화 하는 방식은 특정한 트래픽 패턴을 적합하다
      + 윈도 경계 부근에서 일시적으로 많은 트랙픽이 몰리면 많은 양의 요청을 처리한다
    + 이동 윈도 로깅 알고리즘
      + 요청의 타임스탬프를 추적하여 트래픽이 집중되는 경우 많은 요청을 처리하게 되는 문제를 해결
      + 요청이 오면 타임스탬프를 로그에 남기고 제한된 크기 이상 넘어가면 처리하지 않음
      + 일정 시간이 지나고 새로운 요청이 올 경우, 만료된 로그는 삭제하고 크기를 비교하여 처리한다.
      + 거부된 요청의 타임스탬프도 보관하기 때문에 메모리 사용량이 많고 정교하다
    + 이동 윈도 카운터 알고리즘
      + 위의 두 알고리즘을 결합한 것
      + 짧은 시간에 몰리는 트래픽 대응에 좋음
      + 현재 1분간의 요청 수 + (직전 1분간의 요청 수 * 이동 윈도와 직전 1분이 겹치는 비율)에 따라 현재 윈도에 몇 개의 요청이 왔는지 판단한다.
    + 알고리즘의 기본 아이디어는 얼마나 많은 요청이 접수 되었는지 추적할 수 있는 장치를 두고 이 값이 한도를 넘어서면 거부
    + 구현에 레디스를 많이 사용함 

## (3단계) 상세 설계

- 처리율 제한 규칙 정하기, 초과 트래픽의 처리 방식 정하기(메시지 버리거나 큐에 저장하기)
- 분산 환경에서 처리율 제한 장치를 구현
  + 경쟁조건, 두 개의 스레드가 병렬로 값을 읽고 카운터가 제대로 변경되지 않은 경우, lock말고 루아 스크립트 또는 정렬집합 사용(레디스 자료구조)
  + 동기화 이슈, 레디스와 같은 중앙 집중형 데이터 저장소 사용
  + 성능 최적화, 데이터 센터 사용 데이터 동기화시 최종 일관성 모델 사용(6장)
  + 처리율 알고리즘이 효과적으로 동작하는지 모니터링 



## (4단계) 마무리 

- 요청의 개수는 임계치를 절대 넘을 수 없다(Hard) 잠시 동안은 넘을 수 있다(soft)
- 다양한 계층에서의 처리율 제한 (7계층, 3계층)
- 처리율 제한을 회피하기 위해 클라언트 설계를 어떻게 하는 것이 좋을지 (재시도 횟수 제한, 캐시를 활용한 호출횧수 줄이기)



# [5장] 안정 해시 설계

- 수평적 규모 확장을 위해서는 요청 또는 데이터를 서버에 균등하게 나누는 것이 중요하고 안정 해시는 이 목표를 위해 보편적으로 사용하는 기술
- 해시키 재배치 문제, 여러 서버 중 특정 서버가 죽었을 때 엉뚱한 서버에 접속하는 상황

## 안정 해시 
- 테이블의 크기가 변경될 때, (오직 키의 개수 / 슬롯의 개수) 만큼만 재배치 하는 기술
- 문제점, 파티션의 크기를 균등하게 유지하는 것이 불가능, 키의 균등 분포가 어렵다

## 가상 노드
- 가상 노드란 실제 서버를 가리키는 노드로 하나의 서버는 링 위에서 여러 개의 가상 노드를 가질 수 있음
- 각 서버는 여러개의 파티션을 관리해야 함
- 가상 노드의 개수를 늘리면 키의 분포는 점점 더 균등해짐
- 재배치는 새로 추가된 서버부터 반시계 방향으로 만나는 서버까지 

- 안정해시의 이점은 널리 쓰이는 기술








