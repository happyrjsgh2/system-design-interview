가상 면접 사례로 배우는 대규모 시스템 설계 기초

- 시스템 규모 확장을 위한 기법
	- 웹 계층은 무상태 계층으로
	- 모든 계층에 다중화 도입
	- 가능한 많은 데이터를 캐시할 것
	- 여러 데이터 센터를 지원할 것
	- 정적 콘텐츠는 CDN을 통해 서비스할 것
	- 데이터 계층은 샤딩을 통해 그 규모를 확장할 것
	- 각 계층은 독립적 서비스로 분할할 것
	- 시스템을 지속적으로 모니터링하고 자동화 도구들을 활용할 것

- 웹서버 - DB 서버 분리했을 때 장점
	- 웹 트래픽 처리 서버와 데이터베이스 서버 각각을 독립적으로 확장 가능
- NoSQL 분류
	- key-value store
		- Redis
		- DynamoDB
	- graph store
		- Neo4j
	- column store
		- Cassandra
		- HBase
	- document store
		- MongoDB
		- CouchDB
	- **Timeseries store**
	- Q. 위 각각의 예시?
		- https://roadmap.sh/backend
- NoSQL 이 유리한 경우
	- 매우 낮은 응답 지연시간(latency)이 요구될 때
	- 다루는 데이터가 비정형(unstructured)라서 관계형 데이터가 아닐 때
	- 데이터를 직렬화 or 역직렬화할 수 있기만 하면 될 때
	- 아주 많은 양의 데이터를 저장할 필요가 있을 때
- scale-up 의 한계
	- 규모 확장하는데 한계가 있다.
	- 장애에 대한 자동복구(failover) 방안이나 다중화 방안을 제시하지 않음. 서버에 장애가 발생하면 app이 완전히 중단됨
- 캐시
	- 요청을 받은 웹서버는 캐시에 응답이 저장되어 있는지 본다. 만일 저장되어 있다면 해당 데이터를 클라이언트에 반환
		- 없다면 DB 질의를 통해 데이터를 찾아 캐시에 저장한 뒤 클라이언트에 반환 (read-through caching strategy)
	- **Q. 캐시서버의 정체? 우리가 만든 어플리케이션? or 사용자가 설정 정보 정도만 세팅해서 쓰는 어플리케이션?** 
		- redis client API 를 활용해서 개발자가 코드를 짠다.
	- 캐시 사용시 고려사항
		- 캐시는 언제 쓰는 것이 좋은가?
		- 어떤 데이터를 캐시에 두어야 하는가?
		- 캐시에 보관된 데이터는 어떻게 만료되는가?
		- 일관성은 어떻게 유지되는가?
		- 장애에는 어떻게 대처?
		- 캐시 메모리는 얼마나 크게?
		- 데이터 방출(eviction) 정책은 무엇인가?
- CDN(콘텐츠 전송 네트워크)
	- 정적 콘텐츠를 전송하는 데 쓰이는, 지리적으로 분산된 서버의 네트워크
	- 어떤 사용자가 웹사이트를 방문하면, 그 사용자에게 가장 가까운 CDN 서버가 정적 콘텐츠를 전달하게 된다.
	- **Q. CDN 비즈니스 로직을 application code 로 구현하는 것인가? 제3 사업자에 의해 운영된다는 게 어떤 의미인지? AWS?**
- 무상태 웹 계층
	- 상태 정보 의존적인 웹 계층 문제점
		- 같은 클라이언트로부터의 요청은 항상 같은 서버로 전송되어야 함
	- 무상태 웹 계층 장점
		- 상태 정보가 필요할 경우 공유 저장소로부터 데이터를 가져온다.
			- 사용자로부터의 HTTP 요청은 어떤 웹 서버로든 전달될 수 있다.
		- 단순하고 안정적이며 규모 확장이 쉽다.
- 데이터 센터
	- Netflix 가 여러 데이터센터에 걸쳐 데이터를 어떻게 다중화 하는지?
		- https://netflixtechblog.com/active-active-for-multi-regional-resiliency-c47719f6685b
- 로그, 메트릭 그리고 자동화
	- 메트릭
		- 호스트 단위의 메트릭
			- CPU, 메모리, 디스크 I/O 에 관한 메트릭
		- 종합(aggregated) 메트릭
			- 데이터베이스 계층의 성능, 캐시 계층의 성능
				- Q. 데이터베이스 계층 성능 측정 방법?
		- 핵심 비즈니스 메트릭
			- 일별 능동 사용자, 수익, 재방문 
	- 자동화
		- 지속적 통합을 도와주는 도구를 활용하면 개발자가 만드는 코드가 어떤 검증 절차를 자동으로 거치도록 할 수 있어서 문제를 쉽게 감지할 수 있음
			- Q. 지속적 통합을 도와주는 도구 예시?
- 데이터베이스의 규모 확장
	- 수직적 확장
	- 수평적 확장
		- 샤딩
			- 대규모 데이터베이스를 샤드(shard) 라고 부르는 작은 단위로 분할하는 기술
			- 샤딩 도입 후 고려해야 할 문제
				- 데이터의 재샤딩(resharding)
					- 샤드 키를 계산하는 함수 변경, 데이터 재배치
				- 유명인사 문제
				- 조인과 비정규화(join and de-normalization)

## Chpt 2 개략적인 규모 측정
- 연산 별 응답 지연 값
- ![](attatchments/스크린샷%202023-01-02%20오전%207.38.00.png)

![[스크린샷 2023-01-01 오후 12.46.02.png]]
- 메모리는 빠르지만 디스크는 아직 느리다
- 디스크 탐색은 가능한 피하라
- 단순한 압축 알고리즘은 빠르다
	- 데이터를 인터넷으로 전송하기 전에 가능하면 압축하라
- 데이터 센터는 보통 여러 지역에 분산되어 있고, 센터들 간에 데이터를 주고받는 데는 시간이 걸림

- QPS 와 저장소 요구량 추정 예시
![[스크린샷 2023-01-01 오후 12.51.42.png]]

- **Q. Peek QPS 에서 2를 곱하는 이유..?**
	- -> 100% 사용자가 사용하게 될 수 있어서
- 개략적 규모 추정 문제 빈출
	- QPS
	- 최대 QPS
	- 저장소 요구량
	- 캐시 요구량
	- 서버 수


## Chpt 3 효과적 면접을 위한 4단계 접근법
### 1. 문제 이해 및 설계 범위 확정
- 답부터 들이밀지 말라. 깊이 생각하고 질문하여 요구사항과 가정들을 분명히 하라
- 질문 예시
	- 구체적으로 어떤 기능을 만들어야 하나?
	- 제품 사용자 수는 얼마나 되나?
	- 회사의 규모는 얼마나 빨리 커지리라 예상하나?
	- 회사가 주로 사용하는 기술 스택은 무엇인가? 설계를 단순화하기 위해 활용할 수 있는 기존 서비스로는 어떤 것들이 있는가?
### 2. 개략적인 설계안 제시 및 동의 구하기
- 화이트보드나 종이에 핵심 컴포넌트를 포함하는 다이어그램을 그려라.
	- 클라이언트
	- API
	- 웹 서버
	- 데이터 저장소
	- 캐시
	- CDN
	- 메시지큐
- 예시
	- 피드 발행
![[스크린샷 2023-01-01 오후 1.22.29.png]]

### 3. 상세 설계
- 설계 대상 컴포넌트 사이의 우선순위를 정하라
	- 특정 컴포넌트들의 세부 사항을 깊이 있게 설명
- 피드 발행 기능 상세 설계
![](../../스크린샷%202023-01-01%20오후%206.54.53.png)

![[스크린샷 2023-01-01 오후 1.26.44.png]]

### 4. 마무리
- 추가로 논의하면 좋을 주제들
	- 병목구간, 개선 가능한 지점
	- 설계 요약 설명
	- 오류(서버 오류, 네트워크 장애 등) 발생시 일어나는 일들
	- 운영 관련 논의 (메트릭 수집 및 모니터링 방법, 로그, 배포)
	- 미래에 닥칠 규모 확장 요구에 어떻게 대처할 것인지



---
상영님
- session 에 정보를 담는 것의 대안?

동현님
- primary 가 죽는 경우
	- secondary 를 primary 로 승격
		- AWS 에서 자동으로 해준다.
- CDN
	- FE 개발자분들과 협업이 잦은지?
		- YES. 개발자분들이 코드 배포하면 캐시 무효화 하는 작업 빈번
	- CDN 에 개발자 코드가 들어가는지?
		- NO
- 내가 원하는 데이터가 어느 샤드에 있는지 알 수 있는 방법?
- 세션 DB
	- 